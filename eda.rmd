```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(data.table)
library(tibble)
library(GGally)
library(kableExtra)
library(ggpubr)
library(reshape2)

# <Library imported prior to call
# inserts two dataframe objects into enviroments
# imputedData which is data set with an imputed median for continous variables
# raw_data which is the data frame gained from imported the practicum 2 materials

source("data_cleaning.R")
varsOfInterest = c("age","default","y","job","balance","price","marital","housing","education","loan","log_balance","job_reduced")
dat = imputedData %>% 
  select(varsOfInterest)
numericColumns = c("age","balance","price")
categoricalColumns = c("default","y","job","marital","education","housing","loan")
trainIndexs = sample(1:nrow(dat), size = nrow(dat)/2)
training = dat[trainIndexs,]
testing = dat[-trainIndexs,]
```


### 2.1.  Graphic descriptions of the remaining seven variables related to campaign in the second study, including histograms and density plots.


For this study we were interested in creating a logistic model that was able to capture how the likelihood that a person would buy the product based off of their demographic information. This is in effort to create a generalized model that can be used to predict the success of the Toast-USB.

First, we want to explore the relationship between the demographic variables in the sample, and particularly explore how demographic information affects willingness to purchase Toast-USB. In this case, we can define willingness to purchase the Toast-USB as both the binary (Y/N) favorable response and the price a person said they would be willing to pay for the product. Figure X shows the relationship between age and willingness to purchase.  There is a moderate relationship between age and price, and the figure suggests that individuals on the older end of the spectrum may actually have more a more favorable response to the product.  This is somewhat contridictory to our expectation, given that Millennial and Gen-Z's dual love for technology and gourmet toast served as a compelling reason to enter this market space with the launch of the Toast-USB. This paradoxical relationship could be due to the fact that younger people are more likely to eat-out rather than at home, and therefore are less likely to purchase kitchen appliances.  Additionally, young people establishing their first household may have access to less capital to purchase appliances, resulting in a decreased willingness to purchase among this demographic group.  The figure also demostrated that people had a favorable response to the product were also, on average, willing to pay more for the product.


Next, in Figure X we explored the relationship between logged-balance and willingness to purchase.  Balance representes the amount of non-morgatage credit currently owed by an individual.  If a person has a large balance, it could negatively impact their willingness to purchase the Toast-USB simply because they do not have access to capital. The metric representing balance had both negative values and a strong right-skew.  We performed a linear shift by the largest negative-value balance and a log-transformation to alleviate the skew of the date.

Figure X represents the association between logged balance and willingness to purchase Toast-USB.  The figure does not demonstrate that there is a significant association between balance and willingness to purchase.  Similarly to the relationship demonstrated for age, the figure also suggests that people with a favorable respone were, on average, willing to pay more for Toast-USB.


```{r}
sampleSize = 10000
ggplot(sample_n(training,sampleSize), aes(x = age, y = price, colour = y)) + geom_jitter(alpha = .25) +
  geom_smooth(se = FALSE)
```


```{r}
# I don't think we need to include this plot?
ggplot(sample_n(training,sampleSize), aes(x = age, y = log_balance, colour = y)) + geom_jitter(alpha = .1) +
  geom_smooth(se = FALSE) + ylim(8.5,11)
```

```{r}
#Include in the appendix
mininumBalance = min(raw_data$balance, na.rm = TRUE)
ggplot(training, aes(x = log(balance - mininumBalance))) + geom_density()
```


Figure X demostrated the association between continuous demographic predictors and willingness to purchase the product.  None of the variables have a particularly strong association with willingness to purchase, and there are no obvious instances of collinearity between the continuous demographic predictors.  However, the plots of the continuous predictors do suggest that price is a significant seperator.  As demonstrated in previous exploratory analysis, individuals who had a favorable response to the product were also willing to pay more for it than people who did not have an initial favorable response. 

```{r}
ggplot(sample_n(training,sampleSize), aes(x = , y = price, colour = y)) + geom_point(alpha = .2) +
  geom_smooth(se = FALSE)
```


Figure X shows the association between categorical demographic predictors and their willingness to purchase the Toast-USB.  Variables representing education, default, and loan have a moderate relationship with willingness to purchase. Individuals with secondary and tertiary education have a higher favorable response rate, which could be dually attributable to access to more capital and cultural trends surrounding gourmet toast that are popular within this group.  Additionally, there is a moderate association between willingness to purchase, loan, and default.  We believe that these associations could be related, as individuals with secondary and tertiary education (specifically, individuals attended college) are more likely to have a non-morgatage loan due to the exorbanant cost of education in the United States.  The association of these three variables should be considered in the structure of the logistic model.

```{r}
create_plots <- function(var) {
  ggplot(training, aes(x = fct_reorder(!!ensym(var),!!ensym(var),.fun = 'length'), fill = y )) + geom_bar(stat = 'count')
}

plotList = lapply(categoricalColumns[-c(2,3)],create_plots)

ggarrange(plotlist = plotList)

```

The original dataset obtained by the DOE had 12 factors representing the job classification for individuals in the sample.  The job variable was recoded to represent more broad categories more closely related to profession-type.  Factor levels in the recoded dataset for profession-type include classifications of student, unknown employment, administration, white-collar, and blue-collar. Figure X represents the distribution of favorable response for each of the profession types.  There is no significant association between favorable response and profession type in this sample.  

```{r}
ggplot(training,aes(x = fct_reorder(job_reduced,job_reduced,.fun = 'length'),  fill = y)) + geom_bar(stat='count')
```

After exploratory analysis, we believe that default, education, loan, and age are demographic variables of interest that could be utilized in the logistic model.  For the statistical analysis portion, we aim to build a logistic model that uses relevant demographic variables to predict a favorable response to the Toast-USB and indicate if Toast-Co. should move forward with the launch of the produce.

## Model Process

Continue to examine using defualt, education, loan, age in model


```{r}
formulas <- gen_formula <- function(picks,curfeatures = c("default","education","loan","age")) {
  str_c('y ~',str_c(curfeatures[picks], collapse = '+'))
}

possPicks = list(
c(1),
c(2),
c(3),
c(4),
c(1, 2),
c(1, 3),
c(1, 4),
c(2, 3),
c(2, 4),
c(3, 4),
c(1, 2, 3),
c(1, 2, 4),
c(1, 3, 4),
c(2, 3, 4),
c(1, 2, 3, 4)
)
all_formulas = lapply(possPicks,formulas)
create_glm <- function(formula) {
  glm(formula,data = training, family = binomial)
}
all_models = lapply(all_formulas,create_glm)



```
















# DISCARD


```{r}
#First, we want to make qqnorm plots for all of the continuous variables, which could be used to supplement density plots and justify transformations (include in the appendix)
library(car)
dat.cont <- imputedData[numericColumns]
cont.labels <- colnames(dat.cont)
dat.cont <- dat.cont[-c(3, 5)]
newfun <- function(x, y) qqPlot(x, main = paste(y, "QQ Plot", sep = " "))
par(mfrow = c(2, 3))
mapply(newfun, dat.cont, cont.labels)


ggplot(dat.cont, aes(sample = age)) + geom_qq() +
  geom_qq_line()

#Analysis of which variables have censored Values
incomplete.cases <- function(x){as.numeric(count(dat.cont))-sum(complete.cases(dat.cont[x]))}
lapply(seq(1, 6, 1), incomplete.cases)
# Now let's make Densiy Plots for the variables
melt.dat.cont<- melt(dat.cont)

ggplot(data = melt.dat.cont , aes(x = value)) + stat_density() + facet_wrap(~variable, scales = "free")
```

Based on the density plots, duration and pdays have non-normal distributions. Days represents the day of the month that a person was contacted.  Logically, we do not beliece that this variable will be indicative of a person's likelihood of purchasing a toaster.  Therefore, we will not perform any transformations or include it in the model.  Duration has a strong left skew.  We will perform a log transformation.  

Nick: consider recoding balance as negative and non-negative?

## Necessary Transformations
```{r Transformations}
logduration <- log(imputedData$duration)
logpdays <- log(imputedData$pdays + 1.1)
testdat <- data.frame(logduration, logpdays)

melt.testdat <- melt(testdat)
ggplot(data = melt.testdat , aes(x = value)) + stat_density() + facet_wrap(~variable, scales = "free")

#This helped us for duration.
dat.cont$logduration <- logduration


# Let's take a look at campaign
ggplot(data=imputedData, aes(x=campaign)) + geom_density()
summary(imputedData$campaign)
outliers <- 50:65
imputedData[imputedData$campaign %in% outliers, "campaign"] = NA

```

## 2.2.  A  scatter  plot  matrix  of  all  the  continuous  variables  in  the  secondstudy will be generated to examine association amongst variables for any necessary transformation.



```{r}
ggplot(imputedData, aes(y = duration, x = day, colour = y)) + 
  geom_jitter(alpha = .1)
```



Based on the scatterplot matrix, we do not see any significant collinearity.